<!doctype html>
<!--
More complete loading. Open file, dynamically create video

video8 worked, but not with multiple canvases.

This is from that, allowing experiments without breaking that!
Needs skip implementing. 

testcanvas3 has working upside down videos.

Multiple canvases isn't helping anyway, maybe use it for rotations.

video9 is working with multiple videos but not rotations
video10 is working with rotations and multiple videos. Tested with 2.

videoEditor - intended to be the final version - unnecessary UI elements are removed. 

-->

<html>
<head>
	<title>Video!</title>
	<h1>Javascript Video Editor</h1>
</head>
<body id="mainBody">
	<table>
		<tr>
			<td>
				<p><b>JSON file (load lecture)</b></p>
			</td>
		</tr>
		<tr id = "files">
			<td>
				<input type="file" name="inputfile" id="inputfile" onChange="openJson(this)">			
			</td>
		</tr>
		<tr>
			<td>
				<p><b>Play currently edited video</b></P>
			</td>
			<td>
				<p><b>Skip to...</b></p>
			</td>
		</tr>
		<tr id="controls">
			<td>
				<button type = "button" onClick="play()">Play</button>
			</td>
			<td>
				<select id="clipName">
				</select>
				<input type="text" id="skipTime" name="skipTime" value="0"><br><br>					
			
				<button type = "button" onClick="skipToTime()">Skip</button>			
			</td>
		</tr>
	</table>
	<h3 id="output">Output</h3>
	<canvas id="myCanvas" width="1920" height="1080" style="border:1px solid #c3c3c3;">
	</canvas>

	<script src="Lecture.js"></script>
	<script src="Track.js"></script>
	<script src="Video.js"></script>
	<script src="Clip.js"></script>
	<script>
    //javascript goes here	
	
	/*
		This section deals with loading in videos and arranging them as clips. 
	*/
	
	
	var lecture = null;
	var c = document.getElementById("myCanvas");
    var ctx = c.getContext("2d");
    var timeVar = null;
	
	
	//load existing json fil
	function openJson(input)
	{
		//defaults
		let xDefault = 0;
		let yDefault = 0;	
	
		var fr = new FileReader();           
		
        fr.readAsText(input.files[0]);  
		
		fr.onload = function() {
            
            // Load an object representation of the JSON file. This just a simple object though, so we parse
            // into our Lecture, Video and Clip classes.
            l = JSON.parse(fr.result);

            // Create Lecture instance, setting any undefined attributes to their default values.
            lecture = Lecture.fromJSON(l);
            
            // Create Video instance for each video listed, setting any undefined attributes to their default values.
			for(let i=0;i<l.videos.length;i++)
                lecture.addVideo(Video.fromJSON(l.videos[i]));

            // Create a Track instance for each scheduled clip, recursively creating underlying clips.
            for(let i=0;i<l.tracks.length;i++)
                lecture.addTrack(Track.fromJSON(l.tracks[i]));
        };
		
	}

	//create the video element that allows this video to be loaded 
	//this will add the video to the bottom of the webpage
	function createVideoElement(newVid)
	{
		var vidNode = document.createElement("video");
		vidNode.id = newVid.substring(0,newVid.lastIndexOf("."));
		vidNode.src = newVid;

		var element = document.getElementById("mainBody");
		element.append(vidNode);
		
		vidNode.preload = "auto";
		vidNode.controls = true;
	
		return vidNode;
	}


/*	
	This section deals with video playback and the view of the canvas
*/	
	//get reference to canvas - just use these two lines
	//this is going to be the background context, each video has its own
	//var currentVid = null;

	function play()
	{	
		stopAll();
		c.requestFullscreen();

		//5 secs to wait for full screen warning to leave screen
        setTimeout(startPlaying, lecture.startDelay*1000);
    }
    
    function startPlaying()
    {
        for (let i=0; i<lecture.tracks.length; i++)
        {
            lecture.tracks[i].context.clipIndex = 0;
            startClip(lecture.tracks[i]);
        }

        render();
    }
    
    function render()
    {
        ctx.clearRect(0,0,c.width,c.height);

        for (let i=0; i<lecture.tracks.length; i++) 
            draw(lecture.tracks[i]);
                    
		timeVar = setTimeout(render,20);
    }

	function startClip(track)
	{
        clip = track.clips[track.context.clipIndex];
        clip.reset();
        clip.started = true;

        if (clip.isVideo())
        {
            video = lecture.findVideo(clip.vid);
            video.vid.volume = clip.volume;
            video.vid.currentTime = clip.start;
            video.vid.play();

            track.context.video = video;
        }
	}

	function draw(track)
	{
        let video = track.context.video;
		let clip = track.clips[track.context.clipIndex];

        // if we;ve completed playing the track, ther'es nothing to do.
        if(track.context.clipIndex >= track.clips.length)
            return false;

        if (clip.isWaitFor())
        {
            w = lecture.findClip(clip.vid);
        
            if (w != null && w.hasStarted() && w.position >= clip.delay)
            {
                track.context.clipIndex++;
                if(track.context.clipIndex < track.clips.length)
                    startClip(track);
            }
            
            return false;
        }

        if (clip.isAction())
        {
            w = lecture.findClip(clip.vid);
            if (w != null)
            {
                // Change the target clips attributes to any specified in this clip
                if (clip.x != null)
                    w.x = clip.x;

                if (clip.y != null)
                    w.y = clip.y;

                if (clip.scale != null)
                    w.scale = clip.scale;

                if (clip.volume != null)
                    w.volume = clip.volume;
            }
            
            track.context.clipIndex++;
            if(track.context.clipIndex < track.clips.length)
                startClip(track);

            return false;
        }

        if (clip.isVideo())
        {
            //Snashot cutrrent playout time
            clip.position = video.vid.currentTime;

            // if the video width has yet to be set, try to infer it from the HTML Video elment
            if(video.w == 0)
            {
                video.w = video.vid.videoWidth;
                video.h = video.vid.videoHeight;
            }
            
            // If we've reached the end of video the clip, move on to the next clip (if available)            
            if(video.vid.currentTime >= clip.end)
            {
                video.vid.pause();
                
                track.context.clipIndex++;
                if(track.context.clipIndex < track.clips.length){
                    startClip(track);
                }
                return false;
            }
            
            if(video.vid.paused || video.vid.ended) 
                return false;
            
            transition(video.vid.currentTime,clip.start,clip.end);
                
            if(video.w != 0 && video.vid.currentTime > clip.start && video.vid.currentTime < clip.end){
                let xScale = clip.scale;
                let yScale = clip.scale;
                    
                if(video.w < video.h)
                    xScale = clip.scale*video.w/video.h;
                
                if(video.rotation > 0){
                    video.ctx.drawImage(video.vid,clip.x,clip.y,c.width*xScale,c.height*yScale);
                    ctx.drawImage(video.canvas,0,0,c.width,c.height);
                }
                else	
                    ctx.drawImage(video.vid,clip.x,clip.y,c.width*xScale,c.height*yScale);

                
                if(clip.intro != null && video.vid.currentTime > clip.intro){
                    let localAlpha = ctx.globalAlpha;
                    if(video.vid.currentTime - clip.intro < 1)
                        ctx.globalAlpha = video.vid.currentTime - clip.intro;
                    else
                        ctx.globalAlpha = localAlpha;
                    ctx.drawImage(clip.canvas,0,0,c.width,c.height);		
                    ctx.globalAlpha = localAlpha;
                }	
            }
        }
	}
	
	function transition(time,start,end)
	{
		if(time > start && time < start + 1)
			ctx.globalAlpha = time - start;
		else if(time > end - 1 && time < end)
			ctx.globalAlpha = end - time;
		else
			ctx.globalAlpha = 1.0;
	}
	
	function skipToTime()
	{
		let clipName = document.getElementById("clipName").text;
		let num = parseInt(document.getElementById("skipTime").value);
        let track = null;
        let clip = null;
        let clipIndex = 0;

        for (let i=0; i<lecture.tracks.length; i++)
        {
            track = lecture.tracks[i];

            for(let j=0;j<track.clips.length;j++)
            {
                if(track.clips[j].getLabel()==clipName)
                {
                    clipIndex = j;
                    clip = track.clips[j];
                }
            }
        }
				
		stopAll();
		c.width = 480;
		c.height = 270;
        
        // reset any virtual canvases
		for(let i=0;i<lecture.videos.length;i++){
			if(lecture.videos[i].canvas != null)
			{
				lecture.videos[i].canvas.width = c.width;
				lecture.videos[i].canvas.height = c.height;
				
				lecture.videos[i].ctx.translate(c.width/2,c.height/2);
				lecture.videos[i].ctx.rotate(lecture.videos[i].rotation*Math.PI/180);
				lecture.videos[i].ctx.translate(-c.width/2,-c.height/2);
			}
		}
        
        // TODO: Need to start ALL tracks, and skip forward in time to the appropriate position...
        track.context.clipIndex = clipIndex;
		startClip(track);	
	}
	
	function stopAll()
	{
        clearTimeout(timeVar);

		for(let i=0;i<lecture.videos.length;i++)
		{
			lecture.videos[i].vid.pause();
			lecture.videos[i].vid.load();
		}
		
		c.width = lecture.width;
		c.height = lecture.height;
	
		ctx.clearRect(0,0,c.width,c.height);
	}
		

	</script>
	
</body>

</html>